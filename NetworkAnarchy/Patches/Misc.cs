using ColossalFramework;
using HarmonyLib;
using QCommonLib;
using System;
using UnityEngine;

namespace NetworkAnarchy.Patches
{
    class Utils
    {
        /// <summary>
        /// Remove building limiting errors for networks
        /// </summary>
        /// <param name="errors">The errors generated by the vanilla game</param>
        /// <returns>The pruned down errors</returns>
        internal static ToolBase.ToolErrors YeetLimits(ToolBase.ToolErrors errors)
        {
            if (NetworkAnarchy.Anarchy)
            {
                errors &= ~ToolBase.ToolErrors.CanalTooClose;
                errors &= ~ToolBase.ToolErrors.CannotBuildOnWater;
                errors &= ~ToolBase.ToolErrors.HeightTooHigh;
                errors &= ~ToolBase.ToolErrors.ShoreNotFound;
                errors &= ~ToolBase.ToolErrors.SlopeTooSteep;
                errors &= ~ToolBase.ToolErrors.WaterNotFound;
            }
            return errors;
        }
    }

    /// <summary>
    /// Make ship and airplane paths bulldozeable 
    /// </summary>
    [HarmonyPatch(typeof(DefaultTool), "GetService")]
    public static class DT_GetService
    {
        public static void Postfix(ref ToolBase.RaycastService __result)
        {
            if (QCommon.Scene != QCommon.SceneTypes.Game) return;

            if (Singleton<InfoManager>.instance.CurrentMode == InfoManager.InfoMode.Transport)
            {
                __result.m_itemLayers |= ItemClass.Layer.AirplanePaths | ItemClass.Layer.ShipPaths;
            }
        }
    }

    /// <summary>
    /// Allow ship and airplane paths to be built outside the purchased tiles
    /// Patch deployed by Mods.CrossTheLine
    /// </summary>
    public static class GAM_QuadOutOfArea
    {
        public static bool Prefix(ref bool __result)
        {
            try
            {
                if (!(Singleton<ToolController>.instance.CurrentTool is NetTool)) return true;
                NetTool netTool = (NetTool)Singleton<ToolController>.instance.CurrentTool;
                if (netTool.Prefab == null) return true;
                NetInfo prefab = netTool.Prefab;

                if (prefab.name == "Ship Path" || prefab.name == "Airplane Path")
                {
                    __result = false;
                    return false;
                }
            }
            catch (NullReferenceException e)
            {
                Debug.Log($"Failed to enable placing transport paths outside purchased tiles\n{e}");
            }
            return true;
        }
    }

    /// <summary>
    /// Override the InfoMode underground view
    /// </summary>
    [HarmonyPatch(typeof(InfoManager), "SetCurrentMode")]
    public static class IM_SetCurrentMode
    {
        public static void Prefix(ref InfoManager.InfoMode mode, InfoManager.SubInfoMode subMode)
        {
            if (NetworkAnarchy.instance == null) return;
            NetworkAnarchy inst = NetworkAnarchy.instance;
            if (!inst.IsActive || !inst.IsNetToolEnabled()) return;
            if (mode != InfoManager.InfoMode.Underground) return;
            if (inst.mode == Modes.Tunnel) return;

            var prefab = NetPrefab.GetPrefab(inst.m_current);
            if (prefab == null) return;

            if (inst.mode == Modes.Ground)
            {
                mode = InfoManager.InfoMode.None;
            }
            else if (inst.mode == Modes.Elevated || inst.mode == Modes.Bridge || inst.mode == Modes.Normal)
            {
                if (inst.elevation > -8)
                {
                    mode = InfoManager.InfoMode.None;
                }
            }

            ModInfo.Log.Debug($"IM_SetCurrentMode: \"{prefab.Prefab.name}\" {inst.elevation} ({inst.mode},{prefab.Mode})");
        }
    }
}
